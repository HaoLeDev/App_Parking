
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>AddBTS</title>
    <style>
        /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--Marker clusterer-->
    <script src="~/Scripts/map/markerclusterer.js"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        var locations = [];
        var infoWindowContent = [];
        var monitoring = $.ajax({
            async: false,
            url: '/BtsMap/DataMonitoringByAccount',
            type: 'get',
            data: { 'GetConfig': 'YES' },
            dataType: "JSON"
        }).responseJSON;
        for (i = 0; i < monitoring.length; i++) {
            locations.push({ lat: parseFloat(monitoring[i].LAT), lng: parseFloat(monitoring[i].LNG) });
            infoWindowContent.push('<div class=\'info_content\'><h5>' + monitoring[i].NAME + '</h5></div>');
        };
        function initMap() {
            var infoWindow = new google.maps.InfoWindow();
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: { lat: 21.0333895, lng: 105.8395289 },
                disableDefaultUI: true
            });
            var markers = locations.map(function (location, i) {
                return new google.maps.Marker({
                    position: location,
                    icon: '/Images/bts_station.png'
                });
            });
            for (i = 0; i < markers.length; i++) {
                google.maps.event.addListener(markers[i], 'click', (function (marker, i) {
                    return function () {
                        map.setCenter(markers[i].getPosition());
                        infoWindow.setContent(infoWindowContent[i]);
                        infoWindow.open(map, marker);
                    }
                })(markers[i], i));
            }
            var markerCluster = new MarkerClusterer(map, markers,
                { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
            var chat = $.connection.btsHub;
            chat.client.receivePoint = function (result) {
                console.log(result);
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                google.maps.event.addListener(map, 'click', function (e) {
                    var pointName = prompt("Nhập tên trạm BTS cho vị trí này ?", "Unknow");
                    if (pointName != null) {
                        chat.server.addPointToBTS(e.latLng.lat().toFixed(6), e.latLng.lng().toFixed(6), pointName);
                    }
                });
            });
        }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCr1NUlyT72OCIf5NWys0dC27NodZkYWKI&callback=initMap">
    </script>

</body>
</html>
